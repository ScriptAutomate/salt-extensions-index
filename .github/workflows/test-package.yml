name: Test Package

on:
 workflow_dispatch:
    inputs:
      package:
        description: The package name to test
        required: true
      package_url:
        description: The package URL
        required: true
      salt_versions:
        description: The salt versions to test the package against
        required: true
      python_versions:
        description: The Linux Python versions to test against
        required: true

jobs:

  Linux:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        package:
          - ${{ github.event.inputs.package }}
        python-version: ${{ fromJSON(github.event.inputs.python_versions) }}
        salt-version: ${{ fromJSON(github.event.inputs.salt_versions) }}

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download And Extract ${{ github.event.inputs.package }}
        run: |
          mkdir pkg
          cd pkg
          wget -O - ${{ github.event.inputs.package_url }} | tar zxvf - --strip 1
          ls -lah

      - name: Install Nox
        run: |
          python -m pip install --upgrade pip
          pip install nox

      - name: Test
        env:
          SALT_REQUIREMENT: salt==${{ matrix.salt-version }}
        run: |
          cd pkg
          nox --force-color -e tests-3 -- -vv tests/

  Windows:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        package:
          - ${{ github.event.inputs.package }}
        python-version: ${{ fromJSON(github.event.inputs.python_versions) }}
        salt-version: ${{ fromJSON(github.event.inputs.salt_versions) }}

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download And Extract ${{ github.event.inputs.package }}
        shell: bash
        run: |
          mkdir pkg
          cd pkg
          wget -O - ${{ github.event.inputs.package_url }} | tar zxvf - --strip 1
          ls -lah

      - name: Install Nox
        run: |
          python -m pip install --upgrade pip
          pip install nox

      - name: Test
        env:
          SALT_REQUIREMENT: salt==${{ matrix.salt-version }}
        run: |
          cd pkg
          nox --force-color -e tests-3 -- -vv tests/

  macOS:
    runs-on: macOS-latest

    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        package:
          - ${{ github.event.inputs.package }}
        python-version: ${{ fromJSON(github.event.inputs.python_versions) }}
        salt-version: ${{ fromJSON(github.event.inputs.salt_versions) }}

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download And Extract ${{ github.event.inputs.package }}
        run: |
          mkdir pkg
          cd pkg
          wget -O - ${{ github.event.inputs.package_url }} | tar zxvf - --strip 1
          ls -lah

      - name: Install Nox
        run: |
          python -m pip install --upgrade pip
          pip install nox

      - name: Test
        env:
          SALT_REQUIREMENT: salt==${{ matrix.salt-version }}
        run: |
          cd pkg
          nox --force-color -e tests-3 -- -vv tests/
